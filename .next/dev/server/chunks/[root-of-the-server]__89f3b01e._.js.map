{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/src/app/api/roast/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { GoogleGenAI } from \"@google/genai\";\n\nconst NEYNAR_API_URL = \"https://api.neynar.com/v2/farcaster\";\nconst NEYNAR_API_KEY = process.env.NEYNAR_API_KEY!;\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY!;\n\nconst ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });\n\n// Helper to fetch image and convert to base64\nasync function urlToBase64(url: string): Promise<{ data: string; mimeType: string }> {\n  try {\n    const response = await fetch(url);\n    if (!response.ok) throw new Error(\"Failed to fetch image\");\n    \n    const arrayBuffer = await response.arrayBuffer();\n    const buffer = Buffer.from(arrayBuffer);\n    const base64Data = buffer.toString('base64');\n    \n    const contentType = response.headers.get('content-type') || 'image/png';\n    \n    return { data: base64Data, mimeType: contentType };\n  } catch (error) {\n    console.error(\"Image fetch error:\", error);\n    throw new Error(\"Could not access profile picture for meme generation.\");\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { username } = await request.json();\n\n    if (!username) {\n      return NextResponse.json({ error: 'Username is required' }, { status: 400 });\n    }\n\n    // 1. Fetch user from Neynar\n    const cleanUsername = username.replace(/^@/, '').trim().toLowerCase();\n    \n    const userResponse = await fetch(\n      `${NEYNAR_API_URL}/user/by_username?username=${cleanUsername}&viewer_fid=3`,\n      {\n        headers: {\n          'accept': 'application/json',\n          'api_key': NEYNAR_API_KEY\n        }\n      }\n    );\n\n    if (!userResponse.ok) {\n      if (userResponse.status === 404) {\n        return NextResponse.json({ error: `User @${cleanUsername} does not exist` }, { status: 404 });\n      }\n      return NextResponse.json({ error: 'Failed to fetch user' }, { status: 500 });\n    }\n\n    const userData = await userResponse.json();\n    const user = userData.user;\n\n    // 2. Fetch user casts\n    const castsResponse = await fetch(\n      `${NEYNAR_API_URL}/feed/user/casts?fid=${user.fid}&limit=15&include_replies=false&include_recasts=false`,\n      {\n        headers: {\n          'accept': 'application/json',\n          'api_key': NEYNAR_API_KEY\n        }\n      }\n    );\n\n    if (!castsResponse.ok) {\n      return NextResponse.json({ error: 'Failed to fetch casts' }, { status: 500 });\n    }\n\n    const castsData = await castsResponse.json();\n    const casts = castsData.casts || [];\n\n    // 3. Generate roast with Gemini\n    const castTexts = casts.map((c: any) => \n      `- \"${c.text}\" (Likes: ${c.reactions.likes_count})`\n    ).join('\\n');\n    \n    const roastPrompt = `\n      Identify: Farcaster User @${user.username} (${user.display_name})\n      Bio: \"${user.profile.bio.text}\"\n      Followers: ${user.follower_count}\n      Following: ${user.following_count}\n\n      Recent Activity:\n      ${castTexts}\n\n      Task: Roast this user.\n      \n      Guidelines:\n      - Length: Keep it under 50 words.\n      - Flow: Write a single, cohesive, witty, and savage paragraph. Ensure the sentences connect naturally. Do not just list insults be brutal.\n      - Content: Use specific details from their bio and their casts to mock them.\n      - scan up to three months backward\n      - Tone: Like a ruthless stand-up comedian addressing a heckler.\n      - No hashtags. No labels like \"Roast:\".\n    `;\n\n    const roastResponse = await ai.models.generateContent({\n      model: 'gemini-2.5-flash',\n      contents: roastPrompt,\n      config: {\n        systemInstruction: \"You are a savage roast master and brutal. You speak in a flowing, witty, and devastating manner.\",\n        temperature: 1,\n      }\n    });\n\n    const roast = roastResponse.text || \"You're too boring to roast.\";\n\n    // 4. Generate meme (optional, can fail gracefully)\n    let memeUrl = null;\n    try {\n      const imagePart = await urlToBase64(user.pfp_url);\n\n      const memePrompt = `\n        This is the profile picture of a user I just roasted.\n        The roast was: \"${roast}\"\n        \n        Task: Create a \"Roasted\" meme visual.\n        \n        Actions:\n        1. Use the provided profile picture as the base.\n        2. Apply a heavy visual distortion or filter (like deep fried, clown makeup, tears, fire, or melting) that fits the roast.\n        3. Do NOT add text. The app will add the text overlay separately.\n        4. Output aspect ratio: 1:1 (Square).\n      `;\n\n      const memeResponse = await ai.models.generateContent({\n        model: 'gemini-2.5-flash-image',\n        contents: {\n          parts: [\n            { inlineData: imagePart },\n            { text: memePrompt }\n          ]\n        },\n        config: {\n          imageConfig: {\n            aspectRatio: \"1:1\"\n          }\n        }\n      });\n\n      for (const part of memeResponse.candidates?.[0]?.content?.parts || []) {\n        if (part.inlineData) {\n          memeUrl = `data:image/png;base64,${part.inlineData.data}`;\n          break;\n        }\n      }\n    } catch (memeError) {\n      console.warn(\"Meme generation failed:\", memeError);\n      // Continue without meme\n    }\n\n    return NextResponse.json({\n      user,\n      roast,\n      memeUrl\n    });\n\n  } catch (error: any) {\n    console.error('API Error:', error);\n    return NextResponse.json(\n      { error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}