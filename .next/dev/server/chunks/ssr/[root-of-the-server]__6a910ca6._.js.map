{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/src/app/actions.tsx"],"sourcesContent":["'use server';\n\nimport { GoogleGenAI } from \"@google/genai\";\nimport { Buffer } from \"buffer\";\n\n// --- Types ---\nexport interface FarcasterUser {\n  fid: number;\n  username: string;\n  display_name: string;\n  pfp_url: string;\n  profile: { bio: { text: string } };\n  follower_count: number;\n  following_count: number;\n}\n\nexport interface Cast {\n  hash: string;\n  text: string;\n  parent_hash: string | null;\n  timestamp: string;\n  reactions: { likes_count: number; recasts_count: number };\n}\n\n// --- Configuration ---\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || \"\";\nconst NEYNAR_API_KEY = process.env.NEYNAR_API_KEY || \"\";\nconst NEYNAR_API_URL = process.env.NEYNAR_API_URL || \"https://api.neynar.com/v2/farcaster\";\n\nconst ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });\n\n// --- ACTION 1: Get User & Generate Roast ---\nexport async function roastUserAction(username: string): Promise<{\n  success: boolean;\n  user?: FarcasterUser;\n  roast?: string;\n  error?: string;\n}> {\n  try {\n    if (!GEMINI_API_KEY) throw new Error(\"Missing GEMINI_API_KEY in .env.local\");\n    if (!NEYNAR_API_KEY) throw new Error(\"Missing NEYNAR_API_KEY in .env.local\");\n\n    const cleanUsername = username.replace(/^@/, '').trim().toLowerCase();\n\n    // 1. Fetch User\n    const userRes = await fetch(\n      `${NEYNAR_API_URL}/user/by_username?username=${cleanUsername}&viewer_fid=3`,\n      { headers: { 'accept': 'application/json', 'api_key': NEYNAR_API_KEY }, cache: 'no-store' }\n    );\n\n    if (!userRes.ok) {\n      if (userRes.status === 404) throw new Error(`User @${cleanUsername} not found.`);\n      if (userRes.status === 429) throw new Error(\"Neynar Rate limit hit. Wait a minute.\");\n      throw new Error(\"Failed to fetch user profile.\");\n    }\n    \n    const userData = await userRes.json();\n    const user = userData.user as FarcasterUser;\n\n    // 2. Fetch Casts (Increased limit and INCLUDED replies for the audit)\n    const castsRes = await fetch(\n      `${NEYNAR_API_URL}/feed/user/casts?fid=${user.fid}&limit=30&include_replies=true&include_recasts=false`,\n      { headers: { 'accept': 'application/json', 'api_key': NEYNAR_API_KEY }, cache: 'no-store' }\n    );\n\n    let castTexts = \"\";\n    let replyTexts = \"\";\n\n    if (castsRes.ok) {\n      const castsData = await castsRes.json();\n      const allCasts = (castsData.casts || []) as Cast[];\n      \n      // Separate primary casts from replies\n      const primaryCasts = allCasts.filter(c => !c.parent_hash);\n      const replies = allCasts.filter(c => c.parent_hash);\n\n      castTexts = primaryCasts.slice(0, 10).map(c => `- ${c.text} (Likes: ${c.reactions.likes_count})`).join('\\n');\n      replyTexts = replies.slice(0, 10).map(c => `- ${c.text}`).join('\\n');\n    }\n\n    // 3. Generate Roast - PSYCHOLOGICAL MIND READER PROMPT\n    const ratio = user.follower_count > 0 \n      ? (user.following_count / user.follower_count * 100).toFixed(0) \n      : \"0\";\n\n    const prompt = `\n      TARGET: @${user.username} (${user.display_name})\n      Bio: \"${user.profile.bio.text}\"\n      Stats: ${user.follower_count} followers vs ${user.following_count} following (${ratio}% ratio).\n\n      DATA DUMP (Their recent thoughts):\n      ${castTexts}\n      ${replyTexts || 'NO REPLIES (ghost account vibes)'}\n\n      CRINGE AUDIT PARAMETERS:\n      - Bio Cringe: Tryhard keywords, emoji spam, humblebrags.\n      - Content Patterns: Crypto zombie slang, engagement farming, self-quotes.\n      - Personality Flaws: Desperation, arrogance, boredom.\n\n      TASK: Deliver a STAND-UP COMEDIAN HECKLER ROAST (Max 60 words).\n      \n      STRICT RULES:\n      1. **NO QUOTES**: Do not quote their posts. Do not say \"You said...\".\n      2. **NO DASHES/LISTS**: Write a cohesive paragraph.\n      3. **MIND READER STYLE**: Look into their soul and describe their pathetic reality with additional savage.\n      4. **BE BRUTAL**: Attack their specific insecurities revealed by the data (like, last 100 casts and replies).\n      \n      Example of Desired Style:\n      be creative, brutal, and specific. be unpredictable too\n    `;\n\n    const roastRes = await ai.models.generateContent({\n      model: 'gemini-2.5-flash',\n      contents: prompt,\n      config: {\n        systemInstruction: \"You are a brutal, psychic roast master. You do not quote people; you analyze their soul and destroy them directly.\",\n        temperature: 1,\n      }\n    });\n\n    const roast = roastRes.text || \"You're too boring to roast.\";\n\n    return { success: true, user, roast };\n\n  } catch (error: any) {\n    console.error('Roast Action Error:', error);\n    return { success: false, error: error.message || 'Server error' };\n  }\n}\n\n// --- ACTION 2: Generate Meme (Progressive Loading) ---\nexport async function generateMemeAction(user: FarcasterUser, roast: string): Promise<{\n  success: boolean;\n  memeUrl?: string;\n  error?: string;\n}> {\n  try {\n    if (!GEMINI_API_KEY) throw new Error(\"Missing GEMINI_API_KEY\");\n\n    // Helper to fetch image buffer\n    async function urlToBase64(url: string) {\n      const response = await fetch(url);\n      if (!response.ok) throw new Error(\"Failed to fetch image\");\n      const arrayBuffer = await response.arrayBuffer();\n      const buffer = Buffer.from(arrayBuffer);\n      return {\n        data: buffer.toString('base64'),\n        mimeType: response.headers.get('content-type') || 'image/png'\n      };\n    }\n\n    const imagePart = await urlToBase64(user.pfp_url);\n\n    // Prompt: Focus on VISUAL DISTORTION ONLY. No text inside the image.\n    const memePrompt = `\n      This is the profile picture of a user who just got roasted.\n      Roast context: \"${roast}\"\n      \n      TASK: Apply a heavy, funny visual filter/distortion to this face.\n      Styles: Deep fried, clown makeup, melting, high contrast, or glitch art.\n      \n      IMPORTANT:\n      - OUTPUT ASPECT RATIO MUST BE 1:1.\n      - DO NOT ADD ANY TEXT TO THE IMAGE.\n      - Keep the face recognizable but ridiculed.\n    `;\n\n    const memeRes = await ai.models.generateContent({\n      model: 'gemini-2.5-flash-image',\n      contents: {\n        parts: [\n          { inlineData: imagePart },\n          { text: memePrompt }\n        ]\n      },\n      config: { imageConfig: { aspectRatio: \"1:1\" } }\n    });\n\n    let memeUrl = null;\n    for (const part of memeRes.candidates?.[0]?.content?.parts || []) {\n      if (part.inlineData) {\n        memeUrl = `data:image/png;base64,${part.inlineData.data}`;\n        break;\n      }\n    }\n\n    if (!memeUrl) throw new Error(\"No image generated\");\n\n    return { success: true, memeUrl };\n\n  } catch (error: any) {\n    // Graceful handling for Rate Limits (429) so the app doesn't crash\n    if (error.status === 429 || error.message?.includes('429')) {\n      console.warn(\"Meme generation rate limited (local). Skipping.\");\n      return { success: false, error: \"Rate limit hit (Meme skipped)\" };\n    }\n    console.error(\"Meme Action Error:\", error);\n    return { success: false, error: \"Failed to generate meme\" };\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 305, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {roastUserAction as '406e3405653d65e174f660fc48b6a1922983761d12'} from 'ACTIONS_MODULE0'\nexport {generateMemeAction as '60d9fe79e76b1a05989be5e34f60e48cfebb8cb151'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}