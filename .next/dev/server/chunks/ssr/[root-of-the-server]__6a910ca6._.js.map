{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/src/app/actions.tsx"],"sourcesContent":["'use server';\n\nimport { GoogleGenAI } from \"@google/genai\";\nimport { Buffer } from \"buffer\";\n\n// --- Types ---\nexport interface FarcasterUser {\n  fid: number;\n  username: string;\n  display_name: string;\n  pfp_url: string;\n  profile: { bio: { text: string } };\n  follower_count: number;\n  following_count: number;\n}\n\nexport interface Cast {\n  hash: string;\n  text: string;\n  timestamp: string;\n  reactions: { likes_count: number; recasts_count: number };\n}\n\n// --- Configuration ---\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || \"\";\nconst NEYNAR_API_KEY = process.env.NEYNAR_API_KEY || \"\";\nconst NEYNAR_API_URL = process.env.NEYNAR_API_URL || \"https://api.neynar.com/v2/farcaster\";\n\nconst ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });\n\n// --- ACTION 1: Get User & Generate Roast ---\nexport async function roastUserAction(username: string): Promise<{\n  success: boolean;\n  user?: FarcasterUser;\n  roast?: string;\n  error?: string;\n}> {\n  try {\n    if (!GEMINI_API_KEY) throw new Error(\"Missing GEMINI_API_KEY in .env.local\");\n    if (!NEYNAR_API_KEY) throw new Error(\"Missing NEYNAR_API_KEY in .env.local\");\n\n    const cleanUsername = username.replace(/^@/, '').trim().toLowerCase();\n\n    // 1. Fetch User\n    const userRes = await fetch(\n      `${NEYNAR_API_URL}/user/by_username?username=${cleanUsername}&viewer_fid=3`,\n      { headers: { 'accept': 'application/json', 'api_key': NEYNAR_API_KEY }, cache: 'no-store' }\n    );\n\n    if (!userRes.ok) {\n      if (userRes.status === 404) throw new Error(`User @${cleanUsername} not found.`);\n      if (userRes.status === 429) throw new Error(\"Neynar Rate limit hit. Wait a minute.\");\n      throw new Error(\"Failed to fetch user profile.\");\n    }\n    \n    const userData = await userRes.json();\n    const user = userData.user as FarcasterUser;\n\n    // 2. Fetch Casts\n    const castsRes = await fetch(\n      `${NEYNAR_API_URL}/feed/user/casts?fid=${user.fid}&limit=15&include_replies=false&include_recasts=false`,\n      { headers: { 'accept': 'application/json', 'api_key': NEYNAR_API_KEY }, cache: 'no-store' }\n    );\n\n    let castTexts = \"\";\n    if (castsRes.ok) {\n      const castsData = await castsRes.json();\n      const casts = (castsData.casts || []) as Cast[];\n      castTexts = casts.map(c => `- \"${c.text}\" (Likes: ${c.reactions.likes_count})`).join('\\n');\n    }\n\n    // 3. Generate Roast\n    const prompt = `\n      Identify: Farcaster User @${user.username} (${user.display_name})\n      Bio: \"${user.profile.bio.text}\"\n      Followers: ${user.follower_count}\n      Following: ${user.following_count}\n      \n      Recent Activity:\n      ${castTexts}\n      \n      Task: Roast this user.\n      Guidelines:\n      - Length: Under 50 words.\n      - Style: Savage, witty, direct. Stand-up comedian roasting a heckler.\n      - No hashtags.\n    `;\n\n    const aiRes = await ai.models.generateContent({\n      model: 'gemini-2.5-flash',\n      contents: prompt,\n      config: { temperature: 1 }\n    });\n\n    const roast = aiRes.text || \"You are too boring to roast.\";\n\n    return { success: true, user, roast };\n\n  } catch (error: any) {\n    console.error(\"Roast Action Error:\", error);\n    return { success: false, error: error.message || \"Something went wrong.\" };\n  }\n}\n\n// --- ACTION 2: Generate Meme ---\nexport async function generateMemeAction(user: FarcasterUser, roast: string): Promise<{\n  success: boolean;\n  memeUrl?: string;\n  error?: string;\n}> {\n  try {\n    if (!GEMINI_API_KEY) return { success: false, error: \"API Key Missing\" };\n\n    // 1. Fetch PFP\n    const imgRes = await fetch(user.pfp_url);\n    if (!imgRes.ok) throw new Error(\"Failed to access profile picture.\");\n    \n    const arrayBuffer = await imgRes.arrayBuffer();\n    const base64Data = Buffer.from(arrayBuffer).toString('base64');\n    const mimeType = imgRes.headers.get('content-type') || 'image/png';\n\n    // 2. Generate Meme\n    const prompt = `\n      Context: Profile picture of a roasted user.\n      Roast: \"${roast}\"\n      Task: Create a distorted \"meme\" version of this image.\n      Style: Deep fried, glitch, melting, or clown makeup. \n      IMPORTANT: NO TEXT. Pure visual distortion.\n      Output: 1:1 Aspect Ratio.\n    `;\n\n    try {\n      const aiRes = await ai.models.generateContent({\n        model: 'gemini-2.5-flash-image',\n        contents: {\n          parts: [\n            { inlineData: { mimeType, data: base64Data } },\n            { text: prompt }\n          ]\n        },\n        config: { imageConfig: { aspectRatio: \"1:1\" } }\n      });\n\n      for (const part of aiRes.candidates?.[0]?.content?.parts || []) {\n        if (part.inlineData) {\n          return { \n            success: true, \n            memeUrl: `data:image/png;base64,${part.inlineData.data}` \n          };\n        }\n      }\n      return { success: false, error: \"AI generated no image.\" };\n      \n    } catch (apiError: any) {\n      // Handle Specific 429 Quota Error specifically for images\n      if (apiError.status === 429 || (apiError.message && apiError.message.includes(\"429\"))) {\n        console.warn(\"Meme Generation Quota Exceeded (Local Env):\", apiError.message);\n        return { success: false, error: \"Quota exceeded. Image generation unavailable in this region/tier.\" };\n      }\n      throw apiError;\n    }\n\n  } catch (error: any) {\n    console.error(\"Meme Action Error:\", error);\n    return { success: false, error: error.message };\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 288, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {roastUserAction as '406e3405653d65e174f660fc48b6a1922983761d12'} from 'ACTIONS_MODULE0'\nexport {generateMemeAction as '60d9fe79e76b1a05989be5e34f60e48cfebb8cb151'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}