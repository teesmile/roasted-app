{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 190, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/src/app/actions.tsx"],"sourcesContent":["'use server';\n\nimport { GoogleGenAI } from \"@google/genai\";\nimport { put } from \"@vercel/blob\";\nimport Replicate from \"replicate\";\n\n// --- Types ---\nexport interface FarcasterUser {\n  fid: number;\n  username: string;\n  display_name: string;\n  pfp_url: string;\n  profile: { bio: { text: string } };\n  follower_count: number;\n  following_count: number;\n}\n\nexport interface Cast {\n  hash: string;\n  text: string;\n  parent_hash: string | null;\n  timestamp: string;\n  reactions: { likes_count: number; recasts_count: number };\n}\n\n// --- Configuration ---\n// Note: In Server Actions, process.env vars (without NEXT_PUBLIC) are secure.\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || \"\";\nconst NEYNAR_API_KEY = process.env.NEYNAR_API_KEY || \"\";\nconst NEYNAR_API_URL = process.env.NEYNAR_API_URL || \"https://api.neynar.com/v2/farcaster\";\n\n// --- ACTION 1: Fetch User Data (Neynar) ---\nexport async function fetchUserDataAction(username: string): Promise<{\n  success: boolean;\n  user?: FarcasterUser;\n  castTexts?: string;\n  replyTexts?: string;\n  error?: string;\n}> {\n  try {\n    if (!NEYNAR_API_KEY) throw new Error(\"Missing NEYNAR_API_KEY in .env.local\");\n\n    const cleanUsername = username.replace(/^@/, '').trim().toLowerCase();\n\n    // 1. Fetch User\n    const userRes = await fetch(\n      `${NEYNAR_API_URL}/user/by_username?username=${cleanUsername}&viewer_fid=3`,\n      { headers: { 'accept': 'application/json', 'api_key': NEYNAR_API_KEY }, cache: 'no-store' }\n    );\n\n    if (!userRes.ok) {\n      if (userRes.status === 404) throw new Error(`User @${cleanUsername} not found.`);\n      if (userRes.status === 429) throw new Error(\"Neynar Rate limit hit. Wait a minute.\");\n      throw new Error(\"Failed to fetch user profile.\");\n    }\n    \n    const userData = await userRes.json();\n    const user = userData.user as FarcasterUser;\n\n    // 2. Fetch Casts (Limit 30, include replies)\n    const castsRes = await fetch(\n      `${NEYNAR_API_URL}/feed/user/casts?fid=${user.fid}&limit=30&include_replies=true&include_recasts=false`,\n      { headers: { 'accept': 'application/json', 'api_key': NEYNAR_API_KEY }, cache: 'no-store' }\n    );\n\n    let castTexts = \"\";\n    let replyTexts = \"\";\n\n    if (castsRes.ok) {\n      const castsData = await castsRes.json();\n      const allCasts = (castsData.casts || []) as Cast[];\n      \n      const primaryCasts = allCasts.filter(c => !c.parent_hash);\n      const replies = allCasts.filter(c => c.parent_hash);\n\n      castTexts = primaryCasts.slice(0, 15).map(c => `- ${c.text} (Likes: ${c.reactions.likes_count})`).join('\\n');\n      replyTexts = replies.slice(0, 15).map(c => `- ${c.text}`).join('\\n');\n    }\n\n    return { success: true, user, castTexts, replyTexts };\n\n  } catch (error: any) {\n    console.error('Fetch User Error:', error);\n    return { success: false, error: error.message || 'Server error' };\n  }\n}\n\n// --- ACTION 2: Generate Roast (Gemini) ---\nexport async function generateRoastAction(\n  user: FarcasterUser, \n  castTexts: string, \n  replyTexts: string\n): Promise<{ success: boolean; roast?: string; error?: string }> {\n  try {\n    if (!GEMINI_API_KEY) throw new Error(\"Missing GEMINI_API_KEY in .env.local\");\n    const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });\n\n    const ratio = user.follower_count > 0 \n      ? (user.following_count / user.follower_count * 100).toFixed(0) \n      : \"0\";\n\n    const prompt = `\n      ROAST TARGET: Farcaster User @${user.username} (${user.display_name})\n      Bio: \"${user.profile.bio.text}\"\n      Followers: ${user.follower_count} | Following: ${user.following_count} (${ratio}% ratio ðŸ’€)\n\n      RECENT 90-DAY ACTIVITY (casts + ALL replies - dig for self-owns):\n      ${castTexts}\n      ${replyTexts ? `\\nTHEIR REPLIES (Expose these):\\n${replyTexts}` : '\\nNO REPLIES (ghost account vibes)'}\n\n      CRINGE AUDIT - EXPOSE THESE FIRST:\n      1. **Bio Cringe**: Tryhard keywords, emoji spam, humblebrags, \"DM for collabs\"\n      2. **Follower Ratio**: <10% = desperate followback farmer. >200% = spammer\n      3. **Content Patterns**: \n         - \"gm/fren/wagmi\" count >3 = braindead crypto zombie\n         - Replybegging (\"LFG @vitalik ðŸ‘€\", ratio replies > casts)\n         - Self-quotes, \"just minted\" spam, \"who's building?\" virtue signals\n         - Copy-paste thought-leader diarrhea\n      4. **Engagement Whoring**: Likes-begging, \"drop below\", dead threads\n\n      TASK: Deliver STAND-UP COMEDIAN HECKLER ROAST (60 words max)\n      - Savage. Personal. Hit their deepest insecurity.\n      - Structure: Opening punch â†’ Cringe expose â†’ Brutal closer\n      - Voice: Don Rickles meets @basedjester\n      - NO hashtags, disclaimers, mercy.\n    `;\n\n    const roastRes = await ai.models.generateContent({\n      model: 'gemini-2.5-flash',\n      contents: prompt,\n      config: {\n        systemInstruction: \"You are a savage, ruthless roast master. You speak in a flowing, witty, and devastating manner. You do not list points, you weave them into a single brutal paragraph.\",\n        temperature: 1.1,\n      }\n    });\n\n    const roast = roastRes.text || \"You're too boring to roast.\";\n    return { success: true, roast };\n\n  } catch (error: any) {\n    console.error('Roast Gen Error:', error);\n    return { success: false, error: error.message || 'Server error' };\n  }\n}\n\n\n\n// --- ACTION 3: Generate Meme (Using Replicate) ---\nexport async function generateMemeAction(user: FarcasterUser, roast: string): Promise<{\n  success: boolean;\n  memeUrl?: string;\n  error?: string;\n}> {\n  try {\n    if (!process.env.REPLICATE_API_TOKEN) {\n      throw new Error(\"Missing REPLICATE_API_TOKEN\");\n    }\n\n    const replicate = new Replicate({\n      auth: process.env.REPLICATE_API_TOKEN,\n    });\n\n    console.log(\"Distorting PFP using Instruct-Pix2Pix:\", user.username);\n\n    // Prompt: Instructions for how to change the face\n    const prompt = `\n      Turn this person into a crying clown. \n      Apply a deep fried meme filter. \n      Make the face look devastated, melting, and roasted.\n      Context: ${roast.slice(0, 30)}\n    `;\n\n    // MODEL: Instruct-Pix2Pix\n    // This is the ONLY fast model that reliably edits faces instead of replacing them.\n    const output = await replicate.run(\n      \"timothybrooks/instruct-pix2pix:30c1d0b916a6f8efce20493f5d61ee27491ab2a60437c13c588468b9810ec23f\",\n      {\n        input: {\n          image: user.pfp_url,    // âœ… The PFP goes here\n          prompt: prompt,         // âœ… The command goes here\n          image_guidance_scale: 1.5, // 1.5 = Keep face shape, but change texture\n          num_inference_steps: 20,\n        }\n      }\n    );\n\n    const memeUrl = Array.isArray(output) ? String(output[0]) : String(output);\n\n    return { success: true, memeUrl };\n\n  } catch (error: any) {\n    console.error(\"Replicate Error:\", error);\n    return { success: true, memeUrl: user.pfp_url }; // Fallback to original PFP\n  }\n}\n\n// --- ACTION 4: Upload Image to Vercel Blob ---\nexport async function uploadImageAction(formData: FormData): Promise<string> {\n  const file = formData.get('file') as File;\n  const filename = formData.get('filename') as string;\n\n  if (!file) {\n    throw new Error('No file provided');\n  }\n\n  // Upload to Vercel Blob\n  const blob = await put(filename, file, {\n    access: 'public',\n  });\n\n  return blob.url; // Returns the https://... public URL\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 384, "column": 0}, "map": {"version":3,"sources":["file:///home/tee/projects/personal/farcaster/roasted/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {generateRoastAction as '70638422578e9f9a31d4e9e127812defe5e267b21b'} from 'ACTIONS_MODULE0'\nexport {fetchUserDataAction as '40956cc960b06227ae4762a599faa678d0f80f90c1'} from 'ACTIONS_MODULE0'\nexport {generateMemeAction as '60d9fe79e76b1a05989be5e34f60e48cfebb8cb151'} from 'ACTIONS_MODULE0'\nexport {uploadImageAction as '40a2e178efb798952f0a9f0e3ba82fa274e9a4a5bc'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}